{% extends "base.html" %}

{% block title %}{{ campanha.titulo }} - SOS Comida{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f4f7f6;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23e9ecef' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v19L13 41.5 0 34V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .campanha-header {
        position: relative;
        height: 50vh;
        background-size: cover;
        background-position: center;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem;
    }
    .campanha-header::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to top, rgba(0, 50, 100, 0.7), rgba(0, 0, 0, 0.2));
    }
    .header-content { position: relative; z-index: 2; max-width: 800px; }
    .campanha-title { font-size: 3.5rem; font-weight: 700; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
    .campanha-location { font-size: 1.2rem; opacity: 0.9; }

    .main-container {
        max-width: 900px;
        margin: -80px auto 4rem auto;
        position: relative;
        z-index: 3;
        background: #fff;
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    }
    
    .section-title { 
        font-weight: 600; 
        font-size: 1.8rem; 
        color: #0056b3; 
        margin-bottom: 1.5rem; 
        text-align: center;
    }

    .stat-cards { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
        gap: 1.5rem; 
        margin: 2rem 0; 
    }
    .stat-card { 
        background: #f8f9fa; 
        text-align: center; 
        padding: 1.5rem; 
        border-radius: 10px; 
        border: 1px solid #e9ecef;
    }
    .stat-value { font-size: 2rem; font-weight: 700; color: #0d6efd; }
    .stat-label { font-size: 0.9rem; color: #6c757d; }
    
    .action-panel {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 15px;
        margin-top: 2.5rem;
    }
    .nav-pills .nav-link { 
        color: #0056b3 !important; 
        font-weight: 500; 
        background: white !important;
        border: 1px solid #dee2e6;
        margin: 0 0.25rem;
    }
    .nav-pills .nav-link:hover {
        background: #e9ecef !important;
        color: #0056b3 !important;
    }
    .nav-pills .nav-link.active { 
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }
    .nav-pills .nav-link:focus {
        outline: none;
        box-shadow: none;
    }
    .tab-content { padding-top: 2rem; }

    .item-doacao { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .item-doacao label { font-weight: 500; }
    .item-doacao input { width: 80px; }

    .participante-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    .participante-item:hover {
        background: #e9ecef;
    }
    .participante-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0066CC 0%, #80DDF9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        margin-right: 1rem;
        border: 3px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .participante-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .participante-info {
        flex-grow: 1;
    }
    .participante-nome {
        font-weight: 600;
        color: #343a40;
        margin-bottom: 0.25rem;
    }
    .participante-data {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .participante-acoes {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .btn-ver-perfil {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .btn-denunciar {
        background: #ffc107;
        color: #000;
        border: none;
    }
    .btn-denunciar:hover {
        background: #e0a800;
        color: #000;
    }
    
    .btn-remover-voluntario {
        background: #dc3545;
        color: white;
        border: none;
    }
    .btn-remover-voluntario:hover {
        background: #c82333;
        color: white;
    }
    
    .btn-ver-participantes {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border: none;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-ver-participantes:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="campanha-header" style="background-image: url('{{ url_for('static', filename='img/' + campanha.imagem) }}');">
    <div class="header-content">
        <h1 class="campanha-title">{{ campanha.titulo }}</h1>
        <p class="campanha-location"><i class="fas fa-map-marker-alt"></i> {{ campanha.localizacao }}</p>
    </div>
</div>

<div class="container">
    <div class="main-container">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        
        <h3 class="section-title">Sobre a Campanha</h3>
        <p class="lead text-center" style="color: #495057;">{{ campanha.descricao }}</p>

        {% if campanha.instituicao_delegada %}
        <div class="alert alert-light text-center mt-4">
            <i class="fas fa-university"></i> Organizada por: <strong>{{ campanha.instituicao_delegada.instituicao_nome }}</strong>
        </div>
        {% endif %}

        <div class="stat-cards">
            <div class="stat-card">
                <div class="stat-value">R$ {{ "%.0f"|format(campanha.arrecadado) }}</div>
                <div class="stat-label">Arrecadados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ campanha.voluntarios|length }}</div>
                <div class="stat-label">Voluntários</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ dias_restantes if dias_restantes is not none else 'N/D' }}</div>
                <div class="stat-label">Dias Restantes</div>
            </div>
        </div>

{% if current_user.is_authenticated %}
    {% set usuario_eh_voluntario = namespace(value=False) %}
    {% for voluntario in campanha.voluntarios %}
        {% if voluntario.usuario_id == current_user.id %}
            {% set usuario_eh_voluntario.value = True %}
        {% endif %}
    {% endfor %}
    
    {% set eh_instituicao_responsavel = (current_user.tipo == 'instituicao' and campanha.instituicao_id == current_user.id) %}
    
    {% if current_user.tipo == 'moderador' or usuario_eh_voluntario.value or eh_instituicao_responsavel %}
    <div class="text-center mt-4 mb-4">
        <button type="button" class="btn btn-ver-participantes" data-bs-toggle="modal" data-bs-target="#participantesModal">
            <i class="fas fa-users"></i> Ver Participantes ({{ campanha.voluntarios|length }})
        </button>
    </div>
    {% endif %}
{% endif %}

        <div class="action-panel">
            <h3 class="section-title">Como Ajudar</h3>
            <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-itens">Doar Itens</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-pix">Doar via PIX</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-voluntario">Ser Voluntário</button></li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-itens">
                    <form action="{{ url_for('doar_itens_campanha', campanha_id=campanha.id) }}" method="POST">
                        <p class="text-center text-muted small">Informe a quantidade de itens. Nossa equipe entrará em contato para agendar a coleta.</p>
                        <div class="item-doacao"><label for="qtd_cestas"><i class="fas fa-shopping-basket fa-fw me-2 text-primary"></i>Cestas Básicas</label><input type="number" class="form-control" name="qtd_cestas" value="0" min="0"></div>
                        <div class="item-doacao"><label for="qtd_higiene"><i class="fas fa-pump-soap fa-fw me-2 text-primary"></i>Kits de Higiene</label><input type="number" class="form-control" name="qtd_higiene" value="0" min="0"></div>
                        <div class="item-doacao"><label for="qtd_agua"><i class="fas fa-tint fa-fw me-2 text-primary"></i>Litros de Água</label><input type="number" class="form-control" name="qtd_agua" value="0" min="0"></div>
                        <div class="item-doacao"><label for="qtd_fraldas_infantis"><i class="fas fa-baby fa-fw me-2 text-primary"></i>Fraldas</label><input type="number" class="form-control" name="qtd_fraldas_infantis" value="0" min="0"></div>
                        <div class="d-grid mt-4"><button type="submit" class="btn btn-success btn-lg"><i class="fas fa-box-open"></i> Registrar Doação de Itens</button></div>
                    </form>
                </div>
                <div class="tab-pane fade" id="pills-pix">
                    <form action="{{ url_for('doar_campanha_pix', campanha_id=campanha.id) }}" method="POST">
                        <div class="mb-3"><label for="valor_pix" class="form-label">Qual valor você gostaria de doar? (R$)</label><input type="number" step="0.01" class="form-control" name="valor_pix" placeholder="50,00" required></div>
                        <div class="text-center p-3 rounded" style="background-color: #e9ecef;"><img src="{{ url_for('static', filename='img/qrcode_exemplo.png') }}" alt="QR Code PIX" class="img-fluid" style="max-width: 150px;"><p class="mt-2 small mb-0">Chave PIX (CNPJ):<br><strong>11.111.111/0001-11</strong></p></div>
                        <div class="d-grid mt-3"><button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-dollar-sign"></i> Confirmar Doação</button></div>
                    </form>
                </div>
                <div class="tab-pane fade" id="pills-voluntario">
                    <div class="text-center">
                        <p class="lead">Sua ajuda é fundamental para o sucesso desta campanha!</p>
                        <p>Ao se voluntariar, você poderá ajudar na organização, coleta e distribuição das doações. Clique no botão abaixo para se inscrever.</p>
                        <div class="d-grid mt-4">
                            <a href="{{ url_for('voluntariar', campanha_id=campanha.id) }}" class="btn btn-warning btn-lg"><i class="fas fa-hands-helping"></i> Confirmar Voluntariado</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Participantes -->
<div class="modal fade" id="participantesModal" tabindex="-1" aria-labelledby="participantesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #0056b3, #007bff); color: white;">
        <h5 class="modal-title" id="participantesModalLabel">
            <i class="fas fa-users"></i> Participantes da Campanha
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if campanha.voluntarios %}
            <p class="text-muted text-center mb-4">
                <i class="fas fa-info-circle"></i> Total de {{ campanha.voluntarios|length }} voluntário(s) participando desta campanha
            </p>
            {% for voluntario in campanha.voluntarios %}
            <div class="participante-item">
                <div class="participante-avatar">
                    {% if voluntario.usuario.foto_perfil %}
                        <img src="{{ url_for('static', filename='img/' + voluntario.usuario.foto_perfil) }}" alt="{{ voluntario.usuario.nome }}">
                    {% else %}
                        {{ voluntario.usuario.nome[0].upper() }}
                    {% endif %}
                </div>
                <div class="participante-info">
                    <div class="participante-nome">{{ voluntario.usuario.nome }}</div>
                    <div class="participante-data">
                        <i class="fas fa-calendar-alt"></i> Voluntário desde {{ voluntario.data_inscricao.strftime('%d/%m/%Y') }}
                    </div>
                </div>
                <div class="participante-acoes">
                    <button type="button" class="btn btn-sm btn-primary btn-ver-perfil" data-bs-toggle="modal" data-bs-target="#perfilModal{{ voluntario.usuario.id }}">
                        <i class="fas fa-user"></i> Ver Perfil
                    </button>
                    {% if current_user.tipo == 'moderador' or (current_user.tipo == 'instituicao' and campanha.instituicao_id == current_user.id) %}
                        <button type="button" class="btn btn-sm btn-remover-voluntario btn-ver-perfil" onclick="confirmarRemocao('{{ voluntario.usuario.nome }}', {{ campanha.id }}, {{ voluntario.usuario.id }})">
                            <i class="fas fa-user-times"></i> Remover
                        </button>
                    {% elif current_user.id != voluntario.usuario.id %}
                        <button type="button" class="btn btn-sm btn-denunciar btn-ver-perfil" onclick="abrirDenuncia({{ voluntario.usuario.id }}, '{{ voluntario.usuario.nome }}', {{ campanha.id }})">
                            <i class="fas fa-flag"></i> Denunciar
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhum voluntário ainda</h5>
                <p>Seja o primeiro a se voluntariar nesta campanha!</p>
            </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modais de Perfil -->
{% for voluntario in campanha.voluntarios %}
<div class="modal fade" id="perfilModal{{ voluntario.usuario.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
        <h5 class="modal-title">
            <i class="fas fa-user-circle"></i> Perfil do Voluntário
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="participante-avatar mx-auto" style="width: 100px; height: 100px; font-size: 2.5rem; margin-bottom: 1.5rem;">
            {% if voluntario.usuario.foto_perfil %}
                <img src="{{ url_for('static', filename='img/' + voluntario.usuario.foto_perfil) }}" alt="{{ voluntario.usuario.nome }}">
            {% else %}
                {{ voluntario.usuario.nome[0].upper() }}
            {% endif %}
        </div>
        <h4 class="mb-3">{{ voluntario.usuario.nome }}</h4>
        <div class="row">
            <div class="col-12 mb-3">
                <div class="p-3 bg-light rounded">
                    <i class="fas fa-phone text-primary me-2"></i>
                    <strong>Telefone:</strong><br>
                    <span class="fs-5">{{ voluntario.usuario.telefone if voluntario.usuario.telefone else 'Não informado' }}</span>
                </div>
            </div>
            <div class="col-12 mb-3">
                <div class="p-3 bg-light rounded">
                    <i class="fas fa-envelope text-primary me-2"></i>
                    <strong>Email:</strong><br>
                    <span>{{ voluntario.usuario.email }}</span>
                </div>
            </div>
            {% if voluntario.usuario.cidade %}
            <div class="col-12 mb-3">
                <div class="p-3 bg-light rounded">
                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                    <strong>Cidade:</strong><br>
                    <span>{{ voluntario.usuario.cidade }}</span>
                </div>
            </div>
            {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Modal de Denúncia -->
<div class="modal fade" id="denunciaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
        <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle"></i> Denunciar Voluntário
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formDenuncia" action="{{ url_for('denunciar_voluntario') }}" method="POST">
        <div class="modal-body">
          <p class="text-muted">Use este formulário para reportar problemas com voluntários da campanha.</p>
          
          <div class="mb-3">
            <label class="form-label fw-bold">Motivo da Denúncia *</label>
            <select name="motivo" class="form-select" required>
              <option value="">Selecione um motivo</option>
              <option value="nao_ajudou">Não ajudou na campanha</option>
              <option value="falta_compromisso">Falta de compromisso</option>
              <option value="nao_respondeu">Não respondeu às mensagens</option>
              <option value="comportamento_inadequado">Comportamento inadequado</option>
              <option value="suspeita_fraude">Suspeita de fraude</option>
              <option value="outro">Outro motivo</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">Descreva a Situação *</label>
            <textarea name="descricao" class="form-control" rows="4" placeholder="Explique detalhadamente o que aconteceu..." required></textarea>
            <small class="text-muted">Mínimo de 20 caracteres</small>
          </div>
          
          <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i> <strong>Atenção:</strong> Denúncias falsas podem resultar em penalidades para sua conta.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-paper-plane"></i> Enviar Denúncia
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Função para abrir modal de denúncia
function abrirDenuncia(voluntarioId, voluntarioNome, campanhaId) {
    const modal = document.getElementById('denunciaModal');
    const form = document.getElementById('formDenuncia');
    const modalTitle = modal.querySelector('.modal-title');
    
    // Atualiza título do modal
    modalTitle.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Denunciar: ${voluntarioNome}`;

    // Remove campos ocultos antigos para evitar duplicidade
    form.querySelectorAll('input[name="denunciado_id"], input[name="campanha_id"]').forEach(e => e.remove());

    // Cria campos ocultos atualizados
    const inputDenunciado = document.createElement('input');
    inputDenunciado.type = 'hidden';
    inputDenunciado.name = 'denunciado_id';
    inputDenunciado.value = voluntarioId;
    form.appendChild(inputDenunciado);

    const inputCampanha = document.createElement('input');
    inputCampanha.type = 'hidden';
    inputCampanha.name = 'campanha_id';
    inputCampanha.value = campanhaId;
    form.appendChild(inputCampanha);

    // Limpa o formulário
    form.querySelector('select[name="motivo"]').value = '';
    form.querySelector('textarea[name="descricao"]').value = '';

    // Fecha modal de participantes se estiver aberto
    const participantesModal = bootstrap.Modal.getInstance(document.getElementById('participantesModal'));
    if (participantesModal) {
        participantesModal.hide();
    }

    // Abre modal de denúncia
    const denunciaModal = new bootstrap.Modal(modal);
    denunciaModal.show();
}

// Função para confirmar remoção de voluntário
function confirmarRemocao(voluntarioNome, campanhaId, voluntarioId) {
    if (confirm(`Tem certeza que deseja remover ${voluntarioNome} desta campanha?\n\nEsta ação não pode ser desfeita.`)) {
        window.location.href = `/remover_voluntario/${campanhaId}/${voluntarioId}`;
    }
}

// Validação do formulário de denúncia
document.addEventListener('DOMContentLoaded', function() {
    const formDenuncia = document.getElementById('formDenuncia');
    
    if (formDenuncia) {
        formDenuncia.addEventListener('submit', function(e) {
            const descricao = this.querySelector('textarea[name="descricao"]').value;
            const motivo = this.querySelector('select[name="motivo"]').value;
            const denunciadoId = this.querySelector('input[name="denunciado_id"]');
            const campanhaId = this.querySelector('input[name="campanha_id"]');

            // Validações
            if (!denunciadoId || !denunciadoId.value) {
                e.preventDefault();
                alert('Erro: ID do voluntário não foi encontrado. Tente fechar e abrir o modal novamente.');
                return false;
            }
            
            if (!campanhaId || !campanhaId.value) {
                e.preventDefault();
                alert('Erro: ID da campanha não foi encontrado. Tente recarregar a página.');
                return false;
            }

            if (!motivo) {
                e.preventDefault();
                alert('Por favor, selecione um motivo para a denúncia.');
                return false;
            }

            if (descricao.length < 20) {
                e.preventDefault();
                alert(`A descrição deve ter pelo menos 20 caracteres.\nAtual: ${descricao.length} caracteres`);
                return false;
            }
        });
    }

    // Configuração para reabrir modal de participantes após fechar modal de perfil
    document.querySelectorAll('[id^="perfilModal"]').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function (event) {
            // Pequeno delay para evitar conflitos
            setTimeout(() => {
                const participantesModal = new bootstrap.Modal(document.getElementById('participantesModal'));
                participantesModal.show();
            }, 100);
        });
    });

    // Fecha modal de denúncia e reabre modal de participantes
    const denunciaModal = document.getElementById('denunciaModal');
    if (denunciaModal) {
        denunciaModal.addEventListener('hidden.bs.modal', function () {
            // Pequeno delay para evitar conflitos
            setTimeout(() => {
                const participantesModal = new bootstrap.Modal(document.getElementById('participantesModal'));
                participantesModal.show();
            }, 100);
        });
    }
});
</script>
{% endblock %}