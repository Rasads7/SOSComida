{% extends "base.html" %}

{% block title %}Moderação - SOS Comida{% endblock %}

{% block extra_css %}
<style>

    .nav-tabs-custom {
        border-bottom: 3px solid #0056b3;
        margin-bottom: 2rem;
        background: white;
        border-radius: 10px 10px 0 0;
        padding: 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .nav-tabs-custom .nav-link {
        border: none;
        color: #000 !important;
        font-weight: 600;
        padding: 1rem 1.5rem;
        position: relative;
        transition: all 0.3s ease;
    }
    .nav-tabs-custom .nav-link:hover {
        color: #000 !important;
        background: #f8f9fa;
    }
    .nav-tabs-custom .nav-link.active {
        color: #0056b3 !important;
        background: white;
        border-bottom: 3px solid #0056b3;
    }
    .nav-tabs-custom .nav-link .badge {
        margin-left: 0.5rem;
        font-size: 0.7rem;
    }

    .category-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 5px solid #0056b3;
    }
    .category-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0056b3;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .category-subtitle {
        color: #6c757d;
        margin: 0.5rem 0 0 0;
        font-size: 0.95rem;
    }

    .solicitacoes-grid {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 3rem;
    }
    .solicitacao-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .solicitacao-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .priority-high { border-left: 5px solid #dc3545; }
    .priority-medium { border-left: 5px solid #ffc107; }
    .priority-low { border-left: 5px solid #28a745; }

    .card-header {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        position: relative;
    }
    .card-title { 
        font-size: 1.3rem; 
        font-weight: 600; 
        color: #343a40; 
        margin-bottom: 0.25rem; 
    }
    .card-subtitle { 
        font-size: 0.85rem; 
        color: #6c757d; 
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .card-status {
        position: absolute; 
        top: 1.5rem; 
        right: 1.5rem; 
        font-size: 0.75rem; 
        font-weight: 600;
        padding: 0.4rem 0.8rem; 
        border-radius: 20px; 
    }
    .status-pendente { background: #ffc107; color: #343a40 !important; }
    .status-urgente { background: #dc3545; color: white; }

    .card-body { padding: 1.5rem; }

    .acoes-moderacao { 
        display: flex; 
        gap: 0.75rem; 
        margin-top: 1.5rem; 
        padding-top: 1.5rem; 
        border-top: 1px solid #e9ecef; 
        flex-wrap: wrap;
    }
    .acoes-moderacao form {
        flex: 1;
        display: flex;
    }
    .acoes-moderacao form button {
        width: 100%;
    }
    .btn-aprovar, .btn-rejeitar, .btn-delegar { 
        color: white !important; 
        font-weight: 600; 
        border: none; 
        text-align: center; 
        text-decoration: none; 
        display: inline-flex; 
        justify-content: center; 
        align-items: center; 
        padding: 0.6rem 1.2rem; 
        border-radius: 8px; 
        font-size: 0.85rem;
        transition: all 0.2s ease;
        gap: 0.5rem;
    }
    .btn-aprovar { background-color: #198754; }
    .btn-aprovar:hover { background-color: #157347; }
    .btn-rejeitar { background-color: #dc3545; }
    .btn-rejeitar:hover { background-color: #bb2d3b; }
    .btn-delegar { background-color: #0d6efd; }
    .btn-delegar:hover { background-color: #0b5ed7; }

    .empty-state { 
        text-align: center; 
        padding: 4rem 2rem; 
        color: #6c757d; 
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px dashed #dee2e6;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .logs-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        padding: 2rem;
    }
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #0056b3, #80DDF9);
    }
    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding-left: 2rem;
    }
    .timeline-marker {
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        z-index: 1;
    }
    .timeline-marker-success { background-color: #198754; }
    .timeline-marker-danger { background-color: #dc3545; }
    .timeline-marker-info { background-color: #0d6efd; }
    .timeline-marker-secondary { background-color: #6c757d; }
    
    .timeline-content {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        border-left: 4px solid #0056b3;
    }
    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .timeline-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0056b3;
        margin: 0;
    }
    .timeline-time {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
    .action-description { 
        font-size: 1rem; 
        margin-bottom: 0.5rem; 
        color: #343a40;
    }
    .action-details {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    .item-type {
        background: #0056b3;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .item-name { 
        font-weight: 600; 
        color: #343a40; 
    }
    .item-id {
        font-family: monospace;
        background: #e9ecef;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.8rem;
        color: #6c757d;
    }
    .action-extra-details {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-left: 5px solid;
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-card.success { border-left-color: #198754; }
    .stat-card.danger { border-left-color: #dc3545; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.info { border-left-color: #0dcaf0; }
    .stat-card.primary { border-left-color: #0d6efd; }
    
    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .stat-card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    .stat-card-icon.success { background: #198754; }
    .stat-card-icon.danger { background: #dc3545; }
    .stat-card-icon.warning { background: #ffc107; }
    .stat-card-icon.info { background: #0dcaf0; }
    .stat-card-icon.primary { background: #0d6efd; }
    
    .stat-card-title {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        margin: 0;
    }
    .stat-card-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #343a40;
        margin: 0.5rem 0;
    }
    .stat-card-change {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .stat-card-change.positive {
        color: #198754;
    }
    .stat-card-change.negative {
        color: #dc3545;
    }

    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #343a40;
        margin-bottom: 1.5rem;
    }

    .info-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1rem; 
    }
    .info-item { 
        display: flex; 
        flex-direction: column; 
    }
    .info-label { 
        font-size: 0.75rem; 
        color: #6c757d; 
        font-weight: 600; 
        text-transform: uppercase; 
        margin-bottom: 0.3rem; 
    }
    .info-value { 
        font-size: 0.95rem; 
        font-weight: 500; 
        word-break: break-word;
        color: #343a40;
    }
    .itens-solicitados { 
        background-color: #f0faff; 
        border-radius: 10px; 
        padding: 1rem; 
        margin-top: 1rem; 
    }
    .itens-solicitados h4 { 
        font-size: 1rem; 
        font-weight: 600; 
        color: #0056b3; 
        margin-bottom: 0.75rem; 
    }
    .itens-list { 
        list-style: none; 
        padding: 0; 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
        gap: 0.5rem; 
    }
    .itens-list li { 
        display: flex; 
        justify-content: space-between; 
        padding: 0.3rem 0;
        border-bottom: 1px solid rgba(0,86,179,0.1);
    }
    .itens-list li:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .acoes-moderacao, .timeline-header, .action-details {
            flex-direction: column;
        }
        .btn-aprovar, .btn-rejeitar, .btn-delegar { 
            flex: none; 
        }
        .timeline { 
            padding-left: 1rem; 
        }
        .timeline-item { 
            padding-left: 1.5rem; 
        }
        .timeline-marker { 
            left: -1.5rem; 
            width: 1.5rem; 
            height: 1.5rem; 
            font-size: 0.7rem; 
        }
        .timeline-header, .action-details { 
            gap: 0.5rem; 
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; position: relative; z-index: 10;">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <ul class="nav nav-tabs nav-tabs-custom" id="moderacaoTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ajuda-tab" data-bs-toggle="tab" data-bs-target="#ajuda" type="button" role="tab">
                <i class="fas fa-hands-helping"></i> Pedidos de Ajuda
                <span class="badge bg-warning text-dark">{{ recebimentos_pendentes|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="campanhas-tab" data-bs-toggle="tab" data-bs-target="#campanhas" type="button" role="tab">
                <i class="fas fa-bullhorn"></i> Campanhas Pendentes
                <span class="badge bg-info text-dark">{{ campanhas_pendentes|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="campanhas-ativas-tab" data-bs-toggle="tab" data-bs-target="#campanhas-ativas" type="button" role="tab">
                <i class="fas fa-fire"></i> Campanhas Ativas
                <span class="badge bg-success">{{ campanhas_ativas|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="instituicoes-tab" data-bs-toggle="tab" data-bs-target="#instituicoes" type="button" role="tab">
                <i class="fas fa-university"></i> Instituições
                <span class="badge bg-secondary">{{ instituicoes_pendentes|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="denuncias-tab" data-bs-toggle="tab" data-bs-target="#denuncias" type="button" role="tab">
                <i class="fas fa-flag"></i> Denúncias
                <span class="badge bg-danger">{{ denuncias_pendentes|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                <i class="fas fa-history"></i> Log de Ações
                <span class="badge bg-primary">{{ logs_recentes|length if logs_recentes else 0 }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="moderacaoTabsContent" style="background: white; padding: 2rem; border-radius: 0 0 10px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">

        <div class="tab-pane fade show active" id="ajuda" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-hands-helping"></i> Pedidos de Ajuda Pendentes</h2>
                <p class="category-subtitle">Analise e aprove solicitações de famílias que precisam de ajuda alimentar e produtos básicos.</p>
            </div>
            <div class="solicitacoes-grid" id="ajudaGrid">
                {% if recebimentos_pendentes %}
                    {% for recebimento in recebimentos_pendentes %}
                    <div class="solicitacao-card {% if recebimento.qtd_pessoas >= 5 %}priority-high{% elif recebimento.qtd_pessoas >= 3 %}priority-medium{% else %}priority-low{% endif %}">
                        <div class="card-header">
                            <div class="card-status {% if recebimento.qtd_pessoas >= 5 %}status-urgente{% else %}status-pendente{% endif %}">
                                {% if recebimento.qtd_pessoas >= 5 %}Urgente{% else %}Pendente{% endif %}
                            </div>
                            <h3 class="card-title">{{ recebimento.nome }}</h3>
                            <p class="card-subtitle">
                                <span><i class="fas fa-id-card"></i> ID: {{ recebimento.id }}</span>
                                <span><i class="fas fa-calendar"></i> {{ recebimento.data_criacao.strftime('%d/%m/%Y') }}</span>
                                <span><i class="fas fa-users"></i> {{ recebimento.qtd_pessoas }} pessoas</span>
                            </p>
                        </div>
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Telefone</span>
                                    <span class="info-value">{{ recebimento.telefone }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Endereço</span>
                                    <span class="info-value">{{ recebimento.endereco }}</span>
                                </div>
                            </div>
                            
                            {% if recebimento.necessidades %}
                            <div style="margin-top: 1rem;">
                                <span class="info-label">Necessidades</span>
                                <p style="margin-top: 0.5rem; color: #343a40;">{{ recebimento.necessidades }}</p>
                            </div>
                            {% endif %}
                            
                            {% if recebimento.qtd_cestas or recebimento.qtd_higiene or recebimento.qtd_absorventes or recebimento.qtd_fraldas_infantis or recebimento.qtd_fraldas_geriatricas %}
                            <div class="itens-solicitados">
                                <h4><i class="fas fa-box"></i> Itens Solicitados</h4>
                                <ul class="itens-list">
                                    {% if recebimento.qtd_cestas > 0 %}
                                    <li><span>Cestas Básicas:</span> <strong>{{ recebimento.qtd_cestas }}</strong></li>
                                    {% endif %}
                                    {% if recebimento.qtd_higiene > 0 %}
                                    <li><span>Kits Higiene:</span> <strong>{{ recebimento.qtd_higiene }}</strong></li>
                                    {% endif %}
                                    {% if recebimento.qtd_absorventes > 0 %}
                                    <li><span>Absorventes:</span> <strong>{{ recebimento.qtd_absorventes }}</strong></li>
                                    {% endif %}
                                    {% if recebimento.qtd_fraldas_infantis > 0 %}
                                    <li><span>Fraldas Infantis:</span> <strong>{{ recebimento.qtd_fraldas_infantis }}</strong></li>
                                    {% endif %}
                                    {% if recebimento.qtd_fraldas_geriatricas > 0 %}
                                    <li><span>Fraldas Geriátricas:</span> <strong>{{ recebimento.qtd_fraldas_geriatricas }}</strong></li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            <div class="acoes-moderacao">
                                <form action="{{ url_for('delegar_solicitacao', tipo='recebimento', solicitacao_id=recebimento.id) }}" method="POST" style="flex: 3; display: contents;">
                                    <select name="instituicao_id" class="form-select" required style="flex: 2;">
                                        <option value="">Delegar para...</option>
                                        {% for instituicao in instituicoes %}
                                            <option value="{{ instituicao.id }}">{{ instituicao.instituicao_nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn-aprovar" style="flex: 1;"><i class="fas fa-check"></i> Aprovar e Delegar</button>
                                </form>
                                <form action="{{ url_for('rejeitar_solicitacao', tipo='recebimento', id=recebimento.id) }}" method="POST">
                                    <button type="submit" class="btn-rejeitar"><i class="fas fa-times"></i> Rejeitar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nenhum pedido de ajuda pendente</h3>
                        <p>Todos os pedidos foram processados!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="campanhas" role="tabpanel">
             <div class="category-header">
                <h2 class="category-title"><i class="fas fa-bullhorn"></i> Campanhas Pendentes</h2>
                <p class="category-subtitle">Analise e aprove campanhas criadas por usuários, delegando-as para instituições parceiras.</p>
            </div>
            <div class="solicitacoes-grid">
                {% if campanhas_pendentes %}
                    {% for campanha in campanhas_pendentes %}
                    <div class="solicitacao-card">
                        <div class="card-header">
                             <div class="card-status status-pendente">Pendente</div>
                            <h3 class="card-title">{{ campanha.titulo }}</h3>
                            <p class="card-subtitle">
                                <span><i class="fas fa-id-card"></i> ID: {{ campanha.id }}</span>
                                <span><i class="fas fa-user"></i> Solicitante: {{ campanha.solicitante.nome if campanha.solicitante else 'N/A' }}</span>
                            </p>
                        </div>
                        <div class="card-body">
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <span class="info-label">Descrição</span>
                                <p style="margin-top: 0.5rem; color: #343a40;">{{ campanha.descricao }}</p>
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Localização</span>
                                    <span class="info-value"><i class="fas fa-map-marker-alt"></i> {{ campanha.localizacao }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Meta Financeira</span>
                                    <span class="info-value">R$ {{ "%.2f"|format(campanha.meta_doacoes) }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Meta Voluntários</span>
                                    <span class="info-value">{{ campanha.meta_voluntarios }} voluntários</span>
                                </div>
                            </div>
                            <div class="acoes-moderacao">
                                <form action="{{ url_for('aprovar_campanha', campanha_id=campanha.id) }}" method="POST" style="flex: 3; display: contents;">
                                    <select name="instituicao_id" class="form-select" required style="flex: 2;">
                                        <option value="">Delegar para...</option>
                                        {% for instituicao in instituicoes %}
                                            <option value="{{ instituicao.id }}">{{ instituicao.instituicao_nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn-aprovar" style="flex: 1;"><i class="fas fa-check"></i> Aprovar e Delegar</button>
                                </form>
                                <a href="{{ url_for('editar_campanha_moderacao', campanha_id=campanha.id) }}" class="btn-delegar" style="text-decoration: none;">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                <form action="{{ url_for('rejeitar_solicitacao', tipo='campanha', id=campanha.id) }}" method="POST">
                                    <button type="submit" class="btn-rejeitar" title="Rejeitar"><i class="fas fa-times"></i> Rejeitar</button>
                                </form>
                                <form action="{{ url_for('apagar_campanha', campanha_id=campanha.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja APAGAR permanentemente esta campanha? Esta ação não pode ser desfeita!');">
                                    <button type="submit" class="btn-rejeitar" style="background-color: #6c757d;" title="Apagar permanentemente">
                                        <i class="fas fa-trash"></i> Apagar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nenhuma campanha pendente</h3>
                        <p>Todas as campanhas foram processadas!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="campanhas-ativas" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-fire"></i> Campanhas Ativas</h2>
                <p class="category-subtitle">Gerencie campanhas que já estão ativas no sistema. Você pode editar, suspender ou remover.</p>
            </div>
            <div class="solicitacoes-grid">
                {% if campanhas_ativas %}
                    {% for campanha in campanhas_ativas %}
                    <div class="solicitacao-card" style="border-left-color: #28a745;">
                        <div class="card-header">
                             <div class="card-status" style="background: #28a745; color: white;">Ativa</div>
                            <h3 class="card-title">{{ campanha.titulo }}</h3>
                            <p class="card-subtitle">
                                <span><i class="fas fa-id-card"></i> ID: {{ campanha.id }}</span>
                                <span><i class="fas fa-calendar"></i> Criada em: {{ campanha.data_criacao.strftime('%d/%m/%Y') }}</span>
                                <span><i class="fas fa-users"></i> {{ campanha.voluntarios|length }} voluntários</span>
                            </p>
                        </div>
                        <div class="card-body">
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <span class="info-label">Descrição</span>
                                <p style="margin-top: 0.5rem; color: #343a40;">{{ campanha.descricao[:150] }}{% if campanha.descricao|length > 150 %}...{% endif %}</p>
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Localização</span>
                                    <span class="info-value"><i class="fas fa-map-marker-alt"></i> {{ campanha.localizacao }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Meta Financeira</span>
                                    <span class="info-value">R$ {{ "%.2f"|format(campanha.meta_doacoes) }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Arrecadado</span>
                                    <span class="info-value" style="color: #28a745; font-weight: 700;">R$ {{ "%.2f"|format(campanha.arrecadado) }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Meta Voluntários</span>
                                    <span class="info-value">{{ campanha.meta_voluntarios }} voluntários</span>
                                </div>
                            </div>
                            
                            {% if campanha.instituicao_delegada %}
                            <div style="margin-top: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 8px;">
                                <strong style="color: #0d6efd;"><i class="fas fa-university"></i> Instituição Responsável:</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #0d6efd;">{{ campanha.instituicao_delegada.instituicao_nome }}</p>
                            </div>
                            {% endif %}
                            
                            <div class="acoes-moderacao">
                                <a href="{{ url_for('editar_campanha_moderacao', campanha_id=campanha.id) }}" class="btn-delegar" style="text-decoration: none; flex: 1;">
                                    <i class="fas fa-edit"></i> Editar Campanha
                                </a>
                                <form action="{{ url_for('suspender_campanha', campanha_id=campanha.id) }}" method="POST" style="flex: 1;" onsubmit="return confirm('Tem certeza que deseja SUSPENDER esta campanha? Ela não aparecerá mais para usuários.');">
                                    <button type="submit" class="btn-aprovar" style="background-color: #ffc107; color: #000;">
                                        <i class="fas fa-pause"></i> Suspender
                                    </button>
                                </form>
                                <form action="{{ url_for('apagar_campanha', campanha_id=campanha.id) }}" method="POST" style="flex: 1;" onsubmit="return confirm('ATENÇÃO! Tem certeza que deseja APAGAR permanentemente esta campanha?\n\nIsso vai remover:\n- Todos os voluntários\n- Todas as doações\n- Todo o histórico\n\nEsta ação NÃO PODE SER DESFEITA!');">
                                    <button type="submit" class="btn-rejeitar" style="background-color: #6c757d;">
                                        <i class="fas fa-trash"></i> Apagar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <h3>Nenhuma campanha ativa</h3>
                        <p>Campanhas aprovadas aparecerão aqui!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="instituicoes" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-university"></i> Instituições Pendentes</h2>
                <p class="category-subtitle">Analise e aprove o cadastro de novas instituições parceiras para o programa.</p>
            </div>
            <div class="solicitacoes-grid">
                {% if instituicoes_pendentes %}
                    {% for instituicao in instituicoes_pendentes %}
                    <div class="solicitacao-card">
                        <div class="card-header">
                            <div class="card-status status-pendente">Pendente</div>
                            <h3 class="card-title">{{ instituicao.instituicao_nome or instituicao.nome }}</h3>
                            <p class="card-subtitle">
                                <span><i class="fas fa-calendar"></i> Cadastro: {{ instituicao.data_criacao.strftime('%d/%m/%Y') }}</span>
                                <span><i class="fas fa-tag"></i> Tipo: {{ instituicao.instituicao_tipo|capitalize }}</span>
                            </p>
                        </div>
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">E-mail</span>
                                    <span class="info-value">{{ instituicao.email }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Telefone</span>
                                    <span class="info-value">{{ instituicao.telefone or 'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Endereço</span>
                                    <span class="info-value">{{ instituicao.instituicao_endereco or 'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">CEP</span>
                                    <span class="info-value">{{ instituicao.instituicao_cep or 'N/A' }}</span>
                                </div>
                            </div>
                            <div class="acoes-moderacao">
                                <form action="{{ url_for('aprovar_instituicao', instituicao_id=instituicao.id) }}" method="POST">
                                    <button type="submit" class="btn-aprovar">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                </form>
                                <form action="{{ url_for('rejeitar_instituicao', instituicao_id=instituicao.id) }}" method="POST">
                                    <button type="submit" class="btn-rejeitar">
                                        <i class="fas fa-times"></i> Rejeitar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-university"></i>
                        <h3>Nenhuma instituição pendente</h3>
                        <p>Todas as instituições foram processadas!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="denuncias" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-flag"></i> Denúncias de Voluntários</h2>
                <p class="category-subtitle">Analise e tome ações sobre denúncias de comportamentos inadequados.</p>
            </div>
            
            <div class="solicitacoes-grid">
                {% if denuncias_pendentes %}
                    {% for denuncia in denuncias_pendentes %}
                    <div class="solicitacao-card priority-high">
                        <div class="card-header">
                            <div class="card-status status-urgente">Pendente</div>
                            <h3 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Denúncia #{{ denuncia.id }}
                            </h3>
                            <p class="card-subtitle">
                                <span><i class="fas fa-calendar"></i> {{ denuncia.data_denuncia.strftime('%d/%m/%Y %H:%M') }}</span>
                                <span><i class="fas fa-bullhorn"></i> {{ denuncia.campanha.titulo if denuncia.campanha else 'N/A' }}</span>
                            </p>
                        </div>
                        
                        <div class="card-body">
                            <div class="info-grid" style="margin-bottom: 1.5rem;">
                                <div class="info-item">
                                    <span class="info-label">Denunciante</span>
                                    <span class="info-value">
                                        <i class="fas fa-user"></i> {{ denuncia.denunciante.nome if denuncia.denunciante else 'Desconhecido' }}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Denunciado</span>
                                    <span class="info-value" style="color: #dc3545; font-weight: 600;">
                                        <i class="fas fa-user-times"></i> {{ denuncia.denunciado.nome if denuncia.denunciado else 'Desconhecido' }}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Motivo</span>
                                    <span class="info-value">
                                        {% if denuncia.motivo == 'nao_ajudou' %}
                                            <i class="fas fa-times-circle"></i> Não ajudou
                                        {% elif denuncia.motivo == 'falta_compromisso' %}
                                            <i class="fas fa-user-clock"></i> Falta de compromisso
                                        {% elif denuncia.motivo == 'nao_respondeu' %}
                                            <i class="fas fa-comment-slash"></i> Não respondeu
                                        {% elif denuncia.motivo == 'comportamento_inadequado' %}
                                            <i class="fas fa-ban"></i> Comportamento inadequado
                                        {% else %}
                                            <i class="fas fa-question-circle"></i> Outro
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Campanha</span>
                                    <span class="info-value">
                                        <i class="fas fa-bullhorn"></i> 
                                        <a href="{{ url_for('detalhes_campanha', campanha_id=denuncia.campanha_id) }}" target="_blank" style="color: #0056b3;">
                                            {{ denuncia.campanha.titulo if denuncia.campanha else 'N/A' }}
                                        </a>
                                    </span>
                                </div>
                            </div>
                            
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h5 style="color: #856404; margin: 0 0 0.5rem 0; font-size: 0.9rem; font-weight: 600;">
                                    <i class="fas fa-file-alt"></i> Descrição da denúncia:
                                </h5>
                                <p style="margin: 0; color: #856404; line-height: 1.5;">{{ denuncia.descricao }}</p>
                            </div>

                            <form action="{{ url_for('analisar_denuncia', denuncia_id=denuncia.id) }}" method="POST" style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                                <h5 style="margin: 0 0 1rem 0; color: #0056b3; font-size: 1rem;">
                                    <i class="fas fa-gavel"></i> Tomar ação:
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 600; color: #343a40;">Ação a ser tomada:</label>
                                    <select name="acao" class="form-select" required>
                                        <option value="">Selecione uma ação...</option>
                                        <option value="removido_campanha">🚫 Remover voluntário da campanha</option>
                                        <option value="advertencia">⚠️ Aplicar advertência</option>
                                        <option value="denuncia_improcedente">❌ Denúncia improcedente</option>
                                        <option value="sem_acao">📋 Arquivar sem ação</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 600; color: #343a40;">Observações (opcional):</label>
                                    <textarea name="observacoes" class="form-control" rows="3" placeholder="Adicione observações sobre a decisão tomada..."></textarea>
                                </div>
                                
                                <div class="acoes-moderacao" style="margin-top: 0; padding-top: 0; border-top: none;">
                                    <button type="submit" class="btn-aprovar" style="flex: 1;">
                                        <i class="fas fa-check"></i> Processar Denúncia
                                    </button>
                                    <button type="button" class="btn-rejeitar" style="flex: 0 0 auto;" 
                                            onclick="if(confirm('Deseja arquivar esta denúncia sem análise?')) { 
                                                fetch('{{ url_for('arquivar_denuncia', denuncia_id=denuncia.id) }}', { method: 'POST' })
                                                .then(() => location.reload()); 
                                            }">
                                        <i class="fas fa-archive"></i> Arquivar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-flag"></i>
                        <h3>Nenhuma denúncia pendente</h3>
                        <p>Todas as denúncias foram processadas!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="dashboard" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-chart-line"></i> Dashboard de Estatísticas</h2>
                <p class="category-subtitle">Visão geral de todas as solicitações e ações realizadas no sistema.</p>
            </div>

            <div class="stats-grid">

                <div class="stat-card warning">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Pedidos Pendentes</p>
                        </div>
                        <div class="stat-card-icon warning">
                            <i class="fas fa-hands-helping"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">{{ recebimentos_pendentes|length }}</h3>
                    <p class="stat-card-change">Aguardando análise</p>
                </div>

                <div class="stat-card success">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Pedidos Aprovados</p>
                        </div>
                        <div class="stat-card-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">
                        {{ (logs_recentes | selectattr('acao', 'equalto', 'aprovou_recebimento') | list | length) if logs_recentes else 0 }}
                    </h3>
                    <p class="stat-card-change positive">
                        <i class="fas fa-arrow-up"></i> Verificados
                    </p>
                </div>

                <div class="stat-card danger">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Pedidos Rejeitados</p>
                        </div>
                        <div class="stat-card-icon danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">
                        {{ (logs_recentes | selectattr('acao', 'equalto', 'rejeitou_recebimento') | list | length) if logs_recentes else 0 }}
                    </h3>
                    <p class="stat-card-change">Não aprovados</p>
                </div>

                <div class="stat-card info">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Campanhas Pendentes</p>
                        </div>
                        <div class="stat-card-icon info">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">{{ campanhas_pendentes|length }}</h3>
                    <p class="stat-card-change">Aguardando aprovação</p>
                </div>

                <div class="stat-card success">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Campanhas Aprovadas</p>
                        </div>
                        <div class="stat-card-icon success">
                            <i class="fas fa-check-double"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">
                        {{ (logs_recentes | selectattr('acao', 'equalto', 'aprovou_campanha') | list | length) if logs_recentes else 0 }}
                    </h3>
                    <p class="stat-card-change positive">
                        <i class="fas fa-arrow-up"></i> Ativas
                    </p>
                </div>

                <div class="stat-card primary">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Instituições Pendentes</p>
                        </div>
                        <div class="stat-card-icon primary">
                            <i class="fas fa-university"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">{{ instituicoes_pendentes|length }}</h3>
                    <p class="stat-card-change">Aguardando análise</p>
                </div>

                <div class="stat-card danger">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Denúncias Pendentes</p>
                        </div>
                        <div class="stat-card-icon danger">
                            <i class="fas fa-flag"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">{{ denuncias_pendentes|length }}</h3>
                    <p class="stat-card-change">Aguardando análise</p>
                </div>

                <div class="stat-card primary">
                    <div class="stat-card-header">
                        <div>
                            <p class="stat-card-title">Total de Ações</p>
                        </div>
                        <div class="stat-card-icon primary">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    <h3 class="stat-card-value">{{ logs_recentes|length if logs_recentes else 0 }}</h3>
                    <p class="stat-card-change">Registradas no sistema</p>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Resumo de Ações de Moderação</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                            <h5 style="color: #0056b3; margin-bottom: 1rem;"><i class="fas fa-hands-helping"></i> Pedidos de Ajuda</h5>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-check text-success"></i> Aprovados:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'aprovou_recebimento') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-times text-danger"></i> Rejeitados:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'rejeitou_recebimento') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span><i class="fas fa-clock text-warning"></i> Pendentes:</span>
                                    <strong>{{ recebimentos_pendentes|length }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                            <h5 style="color: #0056b3; margin-bottom: 1rem;"><i class="fas fa-bullhorn"></i> Campanhas</h5>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-check text-success"></i> Aprovadas:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'aprovou_campanha') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-times text-danger"></i> Rejeitadas:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'rejeitou_campanha') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span><i class="fas fa-clock text-warning"></i> Pendentes:</span>
                                    <strong>{{ campanhas_pendentes|length }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                            <h5 style="color: #0056b3; margin-bottom: 1rem;"><i class="fas fa-university"></i> Instituições</h5>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-check text-success"></i> Aprovadas:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'aprovou_instituicao') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-times text-danger"></i> Rejeitadas:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'rejeitou_instituicao') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span><i class="fas fa-clock text-warning"></i> Pendentes:</span>
                                    <strong>{{ instituicoes_pendentes|length }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                            <h5 style="color: #0056b3; margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Atividade Recente</h5>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-plus-circle text-primary"></i> Criações:</span>
                                    <strong>{{ (logs_recentes | selectattr('acao', 'equalto', 'criou_campanha') | list | length) if logs_recentes else 0 }}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span><i class="fas fa-flag text-danger"></i> Denúncias Processadas:</span>
                                    <strong>
                                        {% set denuncias_processadas = 0 %}
                                        {% if logs_recentes %}
                                            {% for log in logs_recentes %}
                                                {% if 'denuncia' in log.acao %}
                                                    {% set denuncias_processadas = denuncias_processadas + 1 %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        {{ denuncias_processadas }}
                                    </strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span><i class="fas fa-history text-secondary"></i> Total de Logs:</span>
                                    <strong>{{ logs_recentes|length if logs_recentes else 0 }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="logs" role="tabpanel">
            <div class="category-header">
                <h2 class="category-title"><i class="fas fa-history"></i> Log de Ações dos Moderadores</h2>
                <p class="category-subtitle">Histórico completo de todas as ações realizadas pelos moderadores do sistema.</p>
            </div>
            
            {% if logs_recentes and logs_recentes|length > 0 %}
                <div class="logs-container">
                    <div class="timeline">
                        {% for log in logs_recentes %}
                        <div class="timeline-item">
                            {% if 'aprovou' in log.acao %}
                                <div class="timeline-marker timeline-marker-success">
                                    <i class="fas fa-check"></i>
                                </div>
                            {% elif 'rejeitou' in log.acao %}
                                <div class="timeline-marker timeline-marker-danger">
                                    <i class="fas fa-times"></i>
                                </div>
                            {% elif 'delegou' in log.acao or 'criou' in log.acao %}
                                <div class="timeline-marker timeline-marker-info">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                            {% else %}
                                <div class="timeline-marker timeline-marker-secondary">
                                    <i class="fas fa-circle"></i>
                                </div>
                            {% endif %}
                            
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h3 class="timeline-title">{{ log.moderador.nome }}</h3>
                                    <span class="timeline-time">
                                        <i class="fas fa-clock"></i> 
                                        {{ log.data_acao.strftime('%d/%m/%Y %H:%M') }}
                                    </span>
                                </div>
                                
                                <div class="action-description">
                                    {% if 'aprovou_campanha' in log.acao %}
                                        <i class="fas fa-check-circle text-success"></i> Aprovou uma campanha
                                    {% elif 'rejeitou_campanha' in log.acao %}
                                        <i class="fas fa-times-circle text-danger"></i> Rejeitou uma campanha
                                    {% elif 'aprovou_recebimento' in log.acao %}
                                        <i class="fas fa-check-circle text-success"></i> Aprovou um pedido de ajuda
                                    {% elif 'rejeitou_recebimento' in log.acao %}
                                        <i class="fas fa-times-circle text-danger"></i> Rejeitou um pedido de ajuda
                                    {% elif 'aprovou_instituicao' in log.acao %}
                                        <i class="fas fa-check-circle text-success"></i> Aprovou uma instituição
                                    {% elif 'rejeitou_instituicao' in log.acao %}
                                        <i class="fas fa-times-circle text-danger"></i> Rejeitou uma instituição
                                    {% elif 'analisou_denuncia' in log.acao %}
                                        <i class="fas fa-gavel text-primary"></i> Analisou uma denúncia
                                    {% elif 'arquivou_denuncia' in log.acao %}
                                        <i class="fas fa-archive text-secondary"></i> Arquivou uma denúncia
                                    {% elif 'delegou' in log.acao %}
                                        <i class="fas fa-share text-info"></i> Delegou uma solicitação
                                    {% elif 'criou_campanha' in log.acao %}
                                        <i class="fas fa-plus-circle text-primary"></i> Criou uma nova campanha
                                    {% elif 'editou_campanha' in log.acao %}
                                        <i class="fas fa-edit text-info"></i> Editou uma campanha
                                    {% elif 'apagou_campanha' in log.acao %}
                                        <i class="fas fa-trash text-danger"></i> Apagou uma campanha
                                    {% elif 'suspendeu_campanha' in log.acao %}
                                        <i class="fas fa-pause text-warning"></i> Suspendeu uma campanha
                                    {% elif 'reativou_campanha' in log.acao %}
                                        <i class="fas fa-play text-success"></i> Reativou uma campanha
                                    {% else %}
                                        <i class="fas fa-info-circle"></i> {{ log.acao|replace('_', ' ')|capitalize }}
                                    {% endif %}
                                </div>
                                
                                <div class="action-details">
                                    <span class="item-type">{{ log.tipo_item|capitalize }}</span>
                                    <span class="item-name">{{ log.item_nome }}</span>
                                    <span class="item-id">ID: #{{ log.item_id }}</span>
                                </div>
                                
                                {% if log.detalhes %}
                                <div class="action-extra-details">
                                    <i class="fas fa-info-circle"></i> {{ log.detalhes }}
                                </div>
                                {% endif %}
                                
                                {% if log.ip_address %}
                                <div class="action-metadata" style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem;">
                                    <i class="fas fa-network-wired"></i> IP: {{ log.ip_address }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>Nenhum log de ação registrado</h3>
                    <p>As ações dos moderadores aparecerão aqui.</p>
                </div>
            {% endif %}
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateRelativeTime() {
        const timeElements = document.querySelectorAll('.relative-time');
        timeElements.forEach(element => {
            const timestamp = element.getAttribute('data-timestamp');
            if (!timestamp) return;
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            let relativeTime;
            if (minutes < 1) {
                relativeTime = 'Agora mesmo';
            } else if (minutes < 60) {
                relativeTime = `${minutes}min atrás`;
            } else if (hours < 24) {
                relativeTime = `${hours}h atrás`;
            } else {
                relativeTime = `${days}d atrás`;
            }
            
            element.textContent = relativeTime;
        });
    }

    updateRelativeTime();
    setInterval(updateRelativeTime, 60000);

    const formsAprovar = document.querySelectorAll('form[action*="aprovar"], form[action*="delegar"]');
    const formsRejeitar = document.querySelectorAll('form[action*="rejeitar"]');
    
    formsAprovar.forEach(form => {
        form.addEventListener('submit', function(e) {
            const selectInstituicao = form.querySelector('select[name="instituicao_id"]');
            if (selectInstituicao && !selectInstituicao.value) {
                e.preventDefault();
                alert('Por favor, selecione uma instituição para delegar.');
                selectInstituicao.focus();
                return false;
            }
        });
    });
    
    formsRejeitar.forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('Tem certeza que deseja rejeitar esta solicitação?')) {
                e.preventDefault();
                return false;
            }
        });
    });
});
</script>
{% endblock %}